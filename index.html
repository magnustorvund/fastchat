<!DOCTYPE html>
<html>
<head>
    <title>Encrypted Chat</title>
    <style>
        #messages { 
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="messages"></div>
    <p><small>To send a private message, type: @username message</small></p>
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>

    <script>
        const username = prompt("Enter your username:") || "Anonymous";
        const ws = new WebSocket(`ws://localhost:8080/ws?username=${username}`);
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        let encryptionKey = null;

        async function decryptMessage(encryptedMsg, key) {
            if (!key) {
                console.error('No encryption key available');
                return encryptedMsg;
            }

            try {
                // Create a proper CryptoKey
                const cryptoKey = await crypto.subtle.importKey(
                    "raw",
                    key,
                    {
                        name: "AES-GCM",
                        length: 256
                    },
                    false,
                    ["decrypt"]
                );

                // Decode base64 message
                const encryptedData = atob(encryptedMsg);
                const encryptedArray = new Uint8Array(encryptedData.split('').map(c => c.charCodeAt(0)));
                
                // Extract nonce and ciphertext
                const nonce = encryptedArray.slice(0, 12);
                const ciphertext = encryptedArray.slice(12);

                const decrypted = await crypto.subtle.decrypt(
                    {
                        name: "AES-GCM",
                        iv: nonce
                    },
                    cryptoKey,
                    ciphertext
                );

                return new TextDecoder().decode(decrypted);
            } catch (error) {
                console.error('Decryption error:', error);
                console.log('Key length:', key ? key.length : 'no key');
                return encryptedMsg;
            }
        }

        ws.onopen = function() {
            console.log("Connected to WebSocket!");
            messages.innerHTML += "<div>Connected to chat!</div>";
        };

        ws.onmessage = async function(e) {
            console.log("Received:", e.data);
            
            // Handle encryption key message
            if (e.data.startsWith('ENCRYPTION_KEY:')) {
                // Extract everything after "ENCRYPTION_KEY:" without including the colon
                const keyBase64 = e.data.replace('ENCRYPTION_KEY:', '').trim();
                try {
                    // Convert base64 to Uint8Array directly
                    const binaryStr = window.atob(keyBase64);
                    encryptionKey = new Uint8Array(binaryStr.length);
                    for (let i = 0; i < binaryStr.length; i++) {
                        encryptionKey[i] = binaryStr.charCodeAt(i);
                    }
                    console.log("Received encryption key, length:", encryptionKey.length, "bytes");
                    return;
                } catch (error) {
                    console.error("Error setting encryption key:", error);
                    console.log("Attempted key:", keyBase64);
                    return;
                }
            }

            const msgDiv = document.createElement('div');
            
            // Don't decrypt system messages
            if (e.data.startsWith('User') || e.data.includes('joined the chat')) {
                msgDiv.textContent = e.data;
            } else if (e.data.startsWith('[Private')) {
                // Handle private messages
                const parts = e.data.split(': ');
                const header = parts[0] + ': ';
                const encryptedContent = parts[1];
                
                try {
                    const decryptedContent = await decryptMessage(encryptedContent, encryptionKey);
                    msgDiv.textContent = header + decryptedContent;
                } catch (error) {
                    msgDiv.textContent = e.data;
                }
            } else {
                // Regular messages
                try {
                    const decryptedMsg = await decryptMessage(e.data, encryptionKey);
                    msgDiv.textContent = `ðŸ”’ ${decryptedMsg}`;
                } catch (error) {
                    msgDiv.textContent = e.data;
                }
            }
            
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        };

        function sendMessage() {
            if (messageInput.value) {
                console.log("Sending:", messageInput.value);
                ws.send(messageInput.value);
                messageInput.value = '';
            }
        }

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>